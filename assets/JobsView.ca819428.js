import{g,d as H,J as dt,T as ut,o as N,a as l,c as r,b as ht,_ as y,r as S,w as E,e as a,n as J,f,h as I,i as bt,u as $,j as G,t as u,k as _t,p as P,l as L,m as K,q as p,s as C,v as Q,x as X,F as b,y as A,z as j,A as M,B as Y,C as x,D as Z,E as tt,G as ft,H as pt,I as kt,K as mt}from"./index.ef21516a.js";import{J as D,L as vt}from"./LastRenderedImage.70bb32d8.js";import{u as R,C as Tt,N as gt,U as Dt}from"./UpdateListener.8db9cd8c.js";import{s as wt,T as q,c as F,d as et,a as yt,u as jt,_ as st,i as at,r as ot}from"./StatusFilterBar.bc457747.js";const O=new D(g()),V=H("jobs",{state:()=>({activeJob:null,activeJobID:"",isJobless:!1}),getters:{canDelete(){return this._anyJobWithStatus(["queued","paused","failed","completed","canceled"])},canCancel(){return this._anyJobWithStatus(["queued","active","failed"])},canRequeue(){return this._anyJobWithStatus(["canceled","completed","failed","paused"])}},actions:{setIsJobless(t){this.$patch({isJobless:t})},setActiveJobID(t){this.$patch({activeJob:{id:t,settings:{},metadata:{}},activeJobID:t})},setActiveJob(t){this.$patch(e=>{e.activeJob=t,e.activeJobID=t.id,e.hasChanged=!0})},deselectAllJobs(){this.$patch({activeJob:null,activeJobID:""})},cancelJobs(){return this._setJobStatus("cancel-requested")},requeueJobs(){return this._setJobStatus("requeueing")},deleteJobs(){return this.activeJobID?O.deleteJob(this.activeJobID):(console.warn("deleteJobs() impossible, no active job ID"),new Promise((t,e)=>{e("No job selected, unable to delete")}))},_anyJobWithStatus(t){return!!this.activeJob&&!!this.activeJob.status&&t.includes(this.activeJob.status)},_setJobStatus(t){if(!this.activeJobID){console.warn(`_setJobStatus(${t}) impossible, no active job ID`);return}const e=new dt(t,"requested from web interface");return O.setJobStatus(this.activeJobID,e)}}}),St=new D(g()),U=H("tasks",{state:()=>({activeTask:null,activeTaskID:""}),getters:{canCancel(){return this._anyTaskWithStatus(["queued","active","soft-failed"])},canRequeue(){return this._anyTaskWithStatus(["canceled","completed","failed"])}},actions:{setActiveTaskID(t){this.$patch({activeTask:{id:t},activeTaskID:t})},setActiveTask(t){this.$patch({activeTask:t,activeTaskID:t.id})},deselectAllTasks(){this.$patch({activeTask:null,activeTaskID:""})},cancelTasks(){return this._setTaskStatus("canceled")},requeueTasks(){return this._setTaskStatus("queued")},_anyTaskWithStatus(t){return!!this.activeTask&&!!this.activeTask.status&&t.includes(this.activeTask.status)},_setTaskStatus(t){if(!this.activeTaskID){console.warn(`_setTaskStatus(${t}) impossible, no active task ID`);return}const e=new ut(t,"requested from web interface");return St.setTaskStatus(this.activeTaskID,e)}}}),B=1e3,it=H("taskLog",{state:()=>({history:[],last:"",lastID:0}),getters:{empty:t=>t.history.length==0},actions:{addTaskLogUpdate(t){this.addChunk(t.log)},clear(){this.$patch(t=>{t.history=[],t.last=null,t.lastID=0,t.hasChanged=!0})},addChunk(t){if(!t)return;const e=t.trimEnd().split(`
`);e.length!=0&&(e.length>B&&e.splice(0,e.length-B),this.$patch(s=>{let n=null;this._pruneState(s,e.length);for(let i of e)n=this._createEntry(s,i),s.history.push(n);if(n==null){console.warn("taskLog.addChunk: there were lines to add, but no entry created. Weird.");return}s.last=n,s.lastID=n.id,s.hasChanged=!0}))},_createEntry(t,e){return{id:this._generateID(t),line:e}},_pruneState(t,e){if(e>B){t.history=[];return}const s=B-e;if(t.history.length<=s)return;const n=t.history.length-s;t.history.splice(0,n)},_generateID(t){return++t.lastID}}}),Jt={id:"notification_list"},It={setup(t){const e=R(),s={columns:[{title:"Time",field:"time",sorter:"alphanum",sorterParams:{alignEmptyValues:"top"},formatter(c){const d=c.getData().time;return wt(d)},widthGrow:1,resizable:!0},{title:"Message",field:"msg",sorter:"string",widthGrow:100,resizable:!0}],initialSort:[{column:"time",dir:"asc"}],headerVisible:!1,layout:"fitDataStretch",resizableColumnFit:!0,height:"calc(25vh - 3rem)",data:e.history,placeholder:"Notification history will appear here",selectable:!1};let n=null;N(()=>{n=new q("#notification_list",s),n.on("tableBuilt",i),n.on("tableBuilt",o)});function i(){e.empty||n.scrollToRow(e.lastID,"bottom",!1)}function o(){e.$subscribe(()=>{n.setData(e.history).then(i)})}return(c,d)=>(l(),r("div",Jt))}},Ct={id:"task_log_list"},$t={setup(t){const e=it(),s=U(),n={columns:[{title:"Log Lines",field:"line",sorter:"string",widthGrow:100,resizable:!0}],headerVisible:!1,layout:"fitDataStretch",resizableColumnFit:!0,height:"calc(25vh - 3rem)",data:e.history,placeholder:"Task log will appear here",selectable:!1};let i=null;N(()=>{i=new q("#task_log_list",n),i.on("tableBuilt",o),i.on("tableBuilt",c),d(s.activeTaskID)}),ht(()=>{e.clear()}),s.$subscribe((h,k)=>{d(k.activeTaskID)});function o(){e.empty||i.scrollToRow(e.lastID,"bottom",!1)}function c(){e.$subscribe(()=>{i.setData(e.history).then(o)})}function d(h){return e.clear(),h?new D(g()).fetchTaskLogTail(h).then(_=>{e.addChunk(_)}):void 0}return(h,k)=>(l(),r("div",Ct))}};const At={emits:["clickClose"],setup(t,{expose:e,emit:s}){const n=localStorage.getItem("footer-popover-active-tab")||"NotificationList",i=S(n),o={NotificationList:It,TaskLog:$t};E(i,async d=>{localStorage.setItem("footer-popover-active-tab",d)});function c(){i.value="TaskLog"}return e({showTaskLogTail:c}),(d,h)=>(l(),r("footer",null,[a("nav",null,[a("ul",null,[a("li",{class:J(["footer-tab",{active:i.value=="NotificationList"}]),onClick:h[0]||(h[0]=k=>i.value="NotificationList")}," Notifications ",2),a("li",{class:J(["footer-tab",{active:i.value=="TaskLog"}]),onClick:h[1]||(h[1]=k=>i.value="TaskLog")}," Task Log ",2),f(Tt),a("li",{class:"collapse",onClick:h[2]||(h[2]=k=>s("clickClose")),title:"Collapse"}," \u2715 ")])]),(l(),I(bt(o[i.value]),{class:"tab"}))]))}};var Pt=y(At,[["__scopeId","data-v-17f06dc3"]]);const nt=t=>(P("data-v-7bb98b65"),t=t(),L(),t),Lt={class:"details-no-item-selected"},Rt={class:"get-the-addon"},Bt=nt(()=>a("p",null,"Get the Blender add-on and submit a job.",-1)),Et=["href"],Ft=nt(()=>a("p",null,"Use the URL below in the add-on preferences. Click on it to copy.",-1)),qt={setup(t){return(e,s)=>(l(),r("div",Lt,[a("div",Rt,[Bt,a("p",null,[a("a",{class:"btn btn-primary",href:$(G)("/flamenco3-addon.zip")},"Get the add-on!",8,Et)]),Ft,a("p",null,[a("span",{class:"click-to-copy",title:"Click to copy this URL",onClick:s[0]||(s[0]=(...n)=>$(F)&&$(F)(...n))},u($(_t)()),1)])])]))}};var Ut=y(qt,[["__scopeId","data-v-7bb98b65"]]);const lt={props:["worker"],setup(t){const e=t,s=K(()=>e.worker.address?`(${e.worker.address})`:"");return(n,i)=>{const o=p("router-link");return l(),I(o,{to:{name:"workers",params:{workerID:t.worker.id}}},{default:C(()=>[Q(u(t.worker.name)+u($(s)),1)]),_:1},8,["to"])}}};const z=t=>(P("data-v-1f477150"),t=t(),L(),t),xt={key:0,class:"dl-no-data"},Ht=z(()=>a("span",null,"Fetching blocklist...",-1)),Nt=[Ht],Vt={key:0,class:"blocklist"},zt=z(()=>a("tr",null,[a("th",null,"Worker"),a("th",null,"Task Type"),a("th")],-1)),Wt=["onClick"],Mt={key:1,class:"dl-no-data"},Ot=z(()=>a("span",null,"This job has no blocked workers.",-1)),Gt=[Ot],Kt={key:2,class:"error"},Qt={props:["jobID"],emits:["reshuffled"],setup(t,{emit:e}){const s=t,n=new D(g()),i=X("isVisible"),o=S(!1),c=S(""),d=S([]);function h(){!i.value||(o.value=!0,n.fetchJobBlocklist(s.jobID).then(_=>{d.value=_}).catch(_=>{c.value=_.message}).finally(()=>{o.value=!1}))}function k(_){n.removeJobBlocklist(s.jobID,{jobBlocklistEntry:[_]}).then(()=>{d.value=d.value.filter(m=>!(m.worker_id==_.worker_id&&m.task_type==_.task_type))}).catch(m=>{console.log("Error removing entry from blocklist",m),h()})}return E(()=>s.jobID,h),E(d,()=>{const _=()=>{e("reshuffled")};M(()=>{M(_)})}),E(i,h),N(h),(_,m)=>(l(),r(b,null,[o.value?(l(),r("div",xt,Nt)):(l(),r(b,{key:1},[d.value.length?(l(),r("table",Vt,[zt,(l(!0),r(b,null,A(d.value,T=>(l(),r("tr",null,[a("td",null,[f(lt,{worker:{id:T.worker_id,name:T.worker_name}},null,8,["worker"])]),a("td",null,u(T.task_type),1),a("td",null,[a("button",{class:"btn in-table-row",onClick:W=>k(T),title:"Allow this worker to execute these task types"},"\u274C",8,Wt)])]))),256))])):(l(),r("div",Mt,Gt))],64)),c.value?(l(),r("p",Kt,"Error fetching blocklist: "+u(c.value),1)):j("",!0)],64))}};var Xt=y(Qt,[["__scopeId","data-v-1f477150"]]);const Yt={props:{title:String},setup(t){const e=t,s=X("selectedTitle"),n=K(()=>s.value===e.title);return Y("isVisible",n),(i,o)=>x((l(),r("div",null,[tt(i.$slots,"default")],512)),[[Z,$(n)]])}};const Zt={class:"tabs-header"},te=["onClick"],ee={emits:["clickedJobDetailsTab"],setup(t,{emit:e}){const s=ft(),n=S(s.default().map(c=>c.props.title)),i=S(n.value[0]);Y("selectedTitle",i);function o(c){i.value=c,e("clickedJobDetailsTab")}return(c,d)=>(l(),r("nav",null,[a("ul",Zt,[(l(!0),r(b,null,A(n.value,h=>(l(),r("li",{key:h,class:J(["tab-item",{active:i.value===h}]),onClick:k=>o(h)},u(h),11,te))),128))]),tt(c.$slots,"default",{},void 0,!0)]))}};var se=y(ee,[["__scopeId","data-v-a4493b1a"]]);const rt=t=>(P("data-v-057a1a16"),t=t(),L(),t),ae={class:"popover-container"},oe={class:"popover"},ie=rt(()=>a("span",null,"Job Priority",-1)),ne={class:"popover-form"},le=rt(()=>a("div",{class:"input-help-text"}," Range 1-100. ",-1)),re={key:0,class:"popover-error"},ce={props:{jobId:String,priority:Number},setup(t){const e=t,s=R(),n=S(e.priority),i=S(!1),o=S("");function c(){const h=new kt(n.value);return new D(g()).setJobPriority(e.jobId,h).then(()=>{s.add(`Updated job priority to ${n.value}`),i.value=!1,o.value=""}).catch(_=>{o.value=_.body.message})}function d(){n.value=e.priority,i.value=!i.value}return(h,k)=>(l(),r("div",ae,[a("span",{onClick:d,class:"popover-toggle",title:"Set priority for this job"},u(t.priority),1),x(a("div",oe,[a("div",{class:"popover-header"},[ie,a("button",{onClick:d},"\u2716")]),a("div",ne,[x(a("input",{type:"number","onUpdate:modelValue":k[0]||(k[0]=_=>n.value=_)},null,512),[[pt,n.value]]),a("button",{onClick:c,class:"btn-primary"},"Set")]),le,o.value?(l(),r("div",re,[a("span",null,u(o.value),1)])):j("",!0)],512),[[Z,i.value]])]))}};var de=y(ce,[["__scopeId","data-v-057a1a16"]]);const ue={props:["jobData"],emits:["reshuffled"],components:{LastRenderedImage:vt,TabItem:Yt,TabsWrapper:se,Blocklist:Xt,PopoverEditableJobPriority:de},data(){return{datetime:et,copyElementText:F,copyElementData:yt,simpleSettings:null,jobsApi:new D(g()),jobType:null,jobTypeSettings:null,showAllSettings:!1,workers:jt()}},mounted(){window.jobDetailsVue=this,objectEmpty(this.jobData)||this._refreshJobSettings(this.jobData),this.workers.refreshClusters().catch(t=>{const e=JSON.stringify(t);this.notifs.add(`Error: ${e}`)})},computed:{hasJobData(){return!!this.jobData&&!!this.jobData.id},hasMetadata(){return this.jobData&&!objectEmpty(this.jobData.metadata)},hasSettings(){return this.jobData&&!objectEmpty(this.settingsToDisplay)},isDeleteRequested(){return this.jobData&&!!this.jobData.delete_requested_at},settingsToDisplay(){return this.showAllSettings?objectEmpty(this.jobData)||objectEmpty(this.jobData.settings)?{}:this.jobData.settings:this.simpleSettings},workerCluster(){if(!!this.jobData.worker_cluster)return this.workers.clustersByID[this.jobData.worker_cluster]}},watch:{jobData(t){!t||!t.id||this._refreshJobSettings(t)}},methods:{refreshLastRenderedImage(t){this.$refs.lastRenderedImage.refreshLastRenderedImage(t)},_refreshJobSettings(t){if(objectEmpty(t)){this._clearJobSettings();return}objectEmpty(this.jobType)||this.jobType.name!=t.type?(this._clearJobSettings(),this.jobsApi.getJobType(t.type).then(this.onJobTypeLoaded).catch(e=>{console.warn("error fetching job type:",e)})):this._setJobSettings(t.settings)},onJobTypeLoaded(t){this.jobType=t;const e={};for(let s of t.settings)e[s.key]=s;this.jobTypeSettings=e,this.jobData&&this._setJobSettings(this.jobData.settings),this.$emit("reshuffled")},_clearJobSettings(){this.simpleSettings=null,this.$emit("reshuffled")},_setJobSettings(t){if(objectEmpty(t)){this._clearJobSettings();return}if(objectEmpty(this.jobTypeSettings)){console.warn("empty job type settings"),this._clearJobSettings();return}const e=new mt,s=new Set([void 0,e.visible,e.web]),n={};for(let i in t){const o=this.jobTypeSettings[i];typeof o!="undefined"&&s.has(o.visible)&&(n[i]=t[i])}this.simpleSettings=n,this.$emit("reshuffled")},emit_reshuffled_delayed(){const t=()=>{this.$emit("reshuffled")};t(),this.$nextTick(t)}}},w=t=>(P("data-v-6d2b3cba"),t=t(),L(),t),he={class:"preview-container"},be={key:0},_e=["title"],fe={key:1,class:"dl-no-data"},pe=w(()=>a("span",null,"This job has no settings.",-1)),ke=[pe],me={key:0},ve=["title"],Te={key:1,class:"dl-no-data"},ge=w(()=>a("span",null,"This job has no metadata.",-1)),De=[ge],we=w(()=>a("dt",{class:"field-name",title:"ID"},"ID",-1)),ye=w(()=>a("dt",{class:"field-name",title:"Worker Cluster"},"Cluster",-1)),je=["title"],Se=["data-clipboard"],Je=w(()=>a("dt",{class:"field-name",title:"Name"},"Name",-1)),Ie=w(()=>a("dt",{class:"field-status",title:"Status"},"Status",-1)),Ce=w(()=>a("dt",{class:"field-type",title:"Type"},"Type",-1)),$e=w(()=>a("dt",{class:"field-priority",title:"Priority"},"Priority",-1)),Ae=w(()=>a("dt",{class:"field-created",title:"Created"},"Created",-1)),Pe=w(()=>a("dt",{class:"field-delete-requested-at",title:"delete-requested-at"},"Delete Request",-1)),Le=w(()=>a("dt",{class:"field-updated",title:"Updated"},"Updated",-1)),Re=w(()=>a("dt",{class:"field-activity",title:"Activity"},"Activity",-1)),Be={key:1,class:"details-no-item-selected"},Ee=w(()=>a("p",null,"Select a job to see its details.",-1)),Fe=[Ee];function qe(t,e,s,n,i,o){const c=p("last-rendered-image"),d=p("TabItem"),h=p("PopoverEditableJobPriority"),k=p("blocklist"),_=p("TabsWrapper");return o.hasJobData?(l(),r(b,{key:0},[a("div",he,[f(c,{ref:"lastRenderedImage",jobID:s.jobData.id,thumbnailSuffix:"-small"},null,8,["jobID"])]),f(_,{onClickedJobDetailsTab:o.emit_reshuffled_delayed},{default:C(()=>[f(d,{title:"Job Settings"},{default:C(()=>[o.hasSettings?(l(),r("dl",be,[(l(!0),r(b,null,A(o.settingsToDisplay,(m,T)=>(l(),r(b,null,[a("dt",{class:J(`field-${T}`),title:T},u(T),11,_e),a("dd",null,u(m),1)],64))),256))])):(l(),r("div",fe,ke))]),_:1}),f(d,{title:"Metadata"},{default:C(()=>[o.hasMetadata?(l(),r("dl",me,[(l(!0),r(b,null,A(s.jobData.metadata,(m,T)=>(l(),r(b,null,[a("dt",{class:J(`field-${T}`),title:T},u(T),11,ve),a("dd",null,u(m),1)],64))),256))])):(l(),r("div",Te,De))]),_:1}),f(d,{title:"Details"},{default:C(()=>[a("dl",null,[we,a("dd",null,[a("span",{onClick:e[0]||(e[0]=(...m)=>i.copyElementText&&i.copyElementText(...m)),class:"click-to-copy"},u(s.jobData.id),1)]),o.workerCluster?(l(),r(b,{key:0},[ye,a("dd",{title:o.workerCluster.description},[a("span",{onClick:e[1]||(e[1]=(...m)=>i.copyElementData&&i.copyElementData(...m)),class:"click-to-copy","data-clipboard":o.workerCluster.id},u(o.workerCluster.name),9,Se)],8,je)],64)):j("",!0),Je,a("dd",null,u(s.jobData.name),1),Ie,a("dd",{class:J(["field-status-label","status-"+s.jobData.status])},u(s.jobData.status),3),Ce,a("dd",null,u(i.jobType?i.jobType.label:s.jobData.type),1),$e,a("dd",null,[f(h,{jobId:s.jobData.id,priority:s.jobData.priority},null,8,["jobId","priority"])]),Ae,a("dd",null,u(i.datetime.relativeTime(s.jobData.created)),1),o.isDeleteRequested?(l(),r(b,{key:1},[Pe,a("dd",null,u(i.datetime.relativeTime(s.jobData.delete_requested_at)),1)],64)):(l(),r(b,{key:2},[Le,a("dd",null,u(i.datetime.relativeTime(s.jobData.updated)),1)],64)),Re,a("dd",null,u(s.jobData.activity),1)])]),_:1}),f(d,{title:"Blocklist"},{default:C(()=>[f(k,{jobID:s.jobData.id,onReshuffled:o.emit_reshuffled_delayed},null,8,["jobID","onReshuffled"])]),_:1})]),_:1},8,["onClickedJobDetailsTab"])],64)):(l(),r("div",Be,Fe))}var Ue=y(ue,[["render",qe],["__scopeId","data-v-6d2b3cba"]]);const xe={name:"JobActionsBar",props:["activeJobID"],data:()=>({jobs:V(),notifs:R(),jobsAPI:new D(g()),deleteInfo:null}),computed:{},watch:{activeJobID(){this._hideDeleteJobPopup()}},methods:{onButtonDelete(){this._startJobDeletionFlow()},onButtonDeleteConfirmed(){return this.jobs.deleteJobs().then(()=>{this.notifs.add("job marked for deletion")}).catch(t=>{const e=JSON.stringify(t);this.notifs.add(`Error: ${e}`)}).finally(this._hideDeleteJobPopup)},onButtonCancel(){return this._handleJobActionPromise(this.jobs.cancelJobs(),"marked for cancellation")},onButtonRequeue(){return this._handleJobActionPromise(this.jobs.requeueJobs(),"requeueing")},_handleJobActionPromise(t,e){return t.then(()=>{})},_startJobDeletionFlow(){if(!this.activeJobID){this.notifs.add("No active job, unable to delete anything");return}this.jobsAPI.deleteJobWhatWouldItDo(this.activeJobID).then(this._showDeleteJobPopup).catch(t=>{const e=JSON.stringify(t);this.notifs.add(`Error: ${e}`)})},_showDeleteJobPopup(t){this.deleteInfo=t},_hideDeleteJobPopup(){this.deleteInfo=null}}},He={class:"btn-bar jobs"},Ne={key:0,class:"btn-bar-popover"},Ve={key:0},ze={key:1},We={class:"inner-btn-bar"},Me=["disabled"],Oe=["disabled"],Ge=["disabled"];function Ke(t,e,s,n,i,o){return l(),r("div",He,[t.deleteInfo!=null?(l(),r("div",Ne,[t.deleteInfo.shaman_checkout?(l(),r("p",Ve,"Delete job, including Shaman checkout?")):(l(),r("p",ze,"Delete job? The job files will be kept.")),a("div",We,[a("button",{class:"btn cancel",onClick:e[0]||(e[0]=(...c)=>o._hideDeleteJobPopup&&o._hideDeleteJobPopup(...c))},"Cancel"),a("button",{class:"btn delete dangerous",onClick:e[1]||(e[1]=(...c)=>o.onButtonDeleteConfirmed&&o.onButtonDeleteConfirmed(...c))},"Delete")])])):j("",!0),a("button",{class:"btn cancel",disabled:!t.jobs.canCancel,onClick:e[2]||(e[2]=(...c)=>o.onButtonCancel&&o.onButtonCancel(...c))},"Cancel Job",8,Me),a("button",{class:"btn requeue",disabled:!t.jobs.canRequeue,onClick:e[3]||(e[3]=(...c)=>o.onButtonRequeue&&o.onButtonRequeue(...c))},"Requeue",8,Oe),a("button",{class:"action delete dangerous",title:"Mark this job for deletion, after asking for a confirmation.",disabled:!t.jobs.canDelete,onClick:e[4]||(e[4]=(...c)=>o.onButtonDelete&&o.onButtonDelete(...c))},"Delete...",8,Ge)])}var Qe=y(xe,[["render",Ke],["__scopeId","data-v-2b4503fc"]]);const Xe={name:"JobsTable",props:["activeJobID"],emits:["tableRowClicked","activeJobDeleted"],components:{JobActionsBar:Qe,StatusFilterBar:st},data:()=>({shownStatuses:[],availableStatuses:[],jobs:V()}),mounted(){window.jobsTableVue=this;const t=this,e={columns:[{title:"Status",field:"status",sorter:"string",formatter:s=>{const n=s.getData().status;return`${at(n)} ${n}`}},{title:"Name",field:"name",sorter:"string"},{title:"Type",field:"type",sorter:"string"},{title:"Prio",field:"priority",sorter:"number"},{title:"Updated",field:"updated",sorter:"alphanum",sorterParams:{alignEmptyValues:"top"},formatter(s){const n=s.getData().updated;return ot(n)}}],rowFormatter(s){const n=s.getData(),i=n.id===t.activeJobID,o=s.getElement().classList;o.toggle("active-row",i),o.toggle("deletion-requested",!!n.delete_requested_at)},initialSort:[{column:"updated",dir:"desc"}],layout:"fitData",layoutColumnsOnNewData:!0,height:"720px",data:[],selectable:!1};this.tabulator=new q("#flamenco_job_list",e),this.tabulator.on("rowClick",this.onRowClick),this.tabulator.on("tableBuilt",this._onTableBuilt),window.addEventListener("resize",this.recalcTableHeight)},unmounted(){window.removeEventListener("resize",this.recalcTableHeight)},watch:{activeJobID(t,e){this._reformatRow(e),this._reformatRow(t)},availableStatuses(){this.$nextTick(this.recalcTableHeight)}},computed:{selectedIDs(){return this.tabulator.getSelectedData().map(t=>t.id)}},methods:{onReconnected(){this.fetchAllJobs()},sortData(){const t=this.tabulator;t.setSort(t.getSorters())},_onTableBuilt(){this.tabulator.setFilter(this._filterByStatus),this.fetchAllJobs()},fetchAllJobs(){const t=new D(g()),e={};this.jobs.isJobless=!1,t.queryJobs(e).then(this.onJobsFetched,function(s){console.error(s)})},onJobsFetched(t){const e=t&&t.jobs&&t.jobs.length>0;this.jobs.isJobless=!e,this.tabulator.setData(t.jobs),this._refreshAvailableStatuses(),this.recalcTableHeight()},processJobUpdate(t){if(!this.tabulator.initialized)return;const e=this.tabulator.rowManager.findRow(t.id);let s=null;t.was_deleted?(e?s=e.delete():s=Promise.resolve(),s.finally(()=>{this.$emit("activeJobDeleted",t.id)})):e?s=this.tabulator.updateData([t]):s=this.tabulator.addData([t]),s.then(this.sortData).then(()=>{this.tabulator.redraw()}).then(this._refreshAvailableStatuses)},onRowClick(t,e){const s=plain(e.getData());this.$emit("tableRowClicked",s)},toggleStatusFilter(t){const e=new Set(this.shownStatuses);e.delete(t)||e.add(t),this.shownStatuses=Array.from(e).sort(),this.tabulator.refreshFilter()},_filterByStatus(t){return this.shownStatuses.length==0?!0:this.shownStatuses.indexOf(t.status)>=0},_refreshAvailableStatuses(){const t=new Set;for(let e of this.tabulator.getData())t.add(e.status);this.availableStatuses=Array.from(t).sort()},_reformatRow(t){const e=this.tabulator.rowManager.findRow(t);!e||(e.reformat?e.reformat():e.reinitialize&&e.reinitialize(!0))},recalcTableHeight(){if(!this.tabulator.initialized)return;const e=this.tabulator.element.parentElement,s=e.parentElement;if(!s)return;const n=s.clientHeight-12;if(e.offsetParent!=e.parentElement){console.warn("JobsTable.recalcTableHeight() only works when the offset parent is the real parent of the element.");return}const i=n-e.offsetTop;this.tabulator.element.clientHeight!=i&&this.tabulator.setHeight(i)}}},Ye=a("h2",{class:"column-title"},"Jobs",-1),Ze={class:"btn-bar-group"},ts={class:"align-right"},es=a("div",null,[a("div",{class:"job-list with-clickable-row",id:"flamenco_job_list"})],-1);function ss(t,e,s,n,i,o){const c=p("job-actions-bar"),d=p("status-filter-bar");return l(),r(b,null,[Ye,a("div",Ze,[f(c,{activeJobID:t.jobs.activeJobID},null,8,["activeJobID"]),a("div",ts,[f(d,{availableStatuses:t.availableStatuses,activeStatuses:t.shownStatuses,onClick:o.toggleStatusFilter},null,8,["availableStatuses","activeStatuses","onClick"])])]),es],64)}var as=y(Xe,[["render",ss]]);const os={props:["taskData"],emits:["showTaskLogTail"],components:{LinkWorker:lt},data(){return{datetime:et,copyElementText:F,jobsApi:new D(g()),notifs:R()}},mounted(){window.taskDetailsVue=this},computed:{hasTaskData(){return!!this.taskData&&!!this.taskData.id}},methods:{openFullLog(){const t=this.taskData.id;this.jobsApi.fetchTaskLogInfo(t).then(e=>{if(e==null){this.notifs.add(`Task ${t} has no log yet`);return}console.log(`task ${t} log info:`,e);const s=G(e.url);window.open(s,"_blank")}).catch(e=>{console.log(`Error fetching task ${t} log info:`,e)})}}},v=t=>(P("data-v-1dfdf1a4"),t=t(),L(),t),is=v(()=>a("h2",{class:"column-title"},"Task Details",-1)),ns=v(()=>a("dt",{class:"field-id",title:"ID"},"ID",-1)),ls=v(()=>a("dt",{class:"field-name",title:"Name"},"Name",-1)),rs=v(()=>a("dt",{class:"field-status",title:"Status"},"Status",-1)),cs=v(()=>a("dt",{class:"field-worker",title:"Assigned To"},"Assigned To",-1)),ds=Q("-"),us=v(()=>a("dt",{class:"field-failed-by-workers",title:"Failed by Workers"},"Failed by Workers",-1)),hs=v(()=>a("dt",{class:"field-type",title:"Task Type"},"Task Type",-1)),bs=v(()=>a("dt",{class:"field-priority",title:"Priority"},"Priority",-1)),_s=v(()=>a("dt",{class:"field-created",title:"Created"},"Created",-1)),fs=v(()=>a("dt",{class:"field-updated",title:"Updated"},"Updated",-1)),ps=v(()=>a("dt",{class:"field-last-touched",title:"Last Touched by Worker"},"Last Touched by Worker",-1)),ks=v(()=>a("dt",{class:"field-activity",title:"Activity"},"Activity",-1)),ms=v(()=>a("h3",{class:"sub-title"},"Commands",-1)),vs=["title"],Ts=v(()=>a("h3",{class:"sub-title"},"Task Log",-1)),gs={class:"btn-bar-group"},Ds={class:"btn-bar tasklog"},ws={key:1,class:"details-no-item-selected"},ys=v(()=>a("p",null,"Select a task to see its details.",-1)),js=[ys];function Ss(t,e,s,n,i,o){const c=p("link-worker");return l(),r(b,null,[is,o.hasTaskData?(l(),r(b,{key:0},[a("dl",null,[ns,a("dd",null,[a("span",{onClick:e[0]||(e[0]=(...d)=>i.copyElementText&&i.copyElementText(...d)),class:"click-to-copy"},u(s.taskData.id),1)]),ls,a("dd",null,u(s.taskData.name),1),rs,a("dd",{class:J(["field-status-label","status-"+s.taskData.status])},u(s.taskData.status),3),cs,a("dd",null,[s.taskData.worker?(l(),I(c,{key:0,worker:s.taskData.worker},null,8,["worker"])):(l(),r(b,{key:1},[ds],64))]),s.taskData.failed_by_workers.length>0?(l(),r(b,{key:0},[us,a("dd",null,[(l(!0),r(b,null,A(s.taskData.failed_by_workers,d=>(l(),r("div",null,[f(c,{worker:d},null,8,["worker"])]))),256))])],64)):j("",!0),hs,a("dd",null,u(s.taskData.task_type),1),bs,a("dd",null,u(s.taskData.priority),1),_s,a("dd",null,u(i.datetime.relativeTime(s.taskData.created)),1),fs,a("dd",null,u(i.datetime.relativeTime(s.taskData.updated)),1),ps,a("dd",null,u(i.datetime.relativeTime(s.taskData.last_touched)),1),ks,a("dd",null,u(s.taskData.activity),1)]),ms,a("dl",null,[(l(!0),r(b,null,A(s.taskData.commands,d=>(l(),r(b,null,[a("dt",{class:J(`field-${d.name}`),title:d.name},u(d.name),11,vs),a("dd",null,u(d.parameters),1)],64))),256))]),Ts,a("div",gs,[a("section",Ds,[a("button",{class:"btn",onClick:e[1]||(e[1]=d=>t.$emit("showTaskLogTail")),title:"Open the task log tail in the footer."}," Follow Task Log"),a("button",{class:"btn",onClick:e[2]||(e[2]=(...d)=>o.openFullLog&&o.openFullLog(...d)),title:"Opens the task log in a new window."},"Open Full Log")])])],64)):(l(),r("div",ws,js))],64)}var Js=y(os,[["render",Ss],["__scopeId","data-v-1dfdf1a4"]]);const Is={name:"TaskActionsBar",data:()=>({tasks:U(),notifs:R()}),computed:{},methods:{onButtonCancel(){return this._handleTaskActionPromise(this.tasks.cancelTasks(),"cancelled")},onButtonRequeue(){return this._handleTaskActionPromise(this.tasks.requeueTasks(),"requeueing")},_handleTaskActionPromise(t,e){return t.then(()=>{}).catch(s=>{const n=JSON.stringify(s);this.notifs.add(`Error: ${n}`)})}}},Cs={class:"btn-bar tasks"},$s=["disabled"],As=["disabled"];function Ps(t,e,s,n,i,o){return l(),r("section",Cs,[a("button",{class:"btn cancel",disabled:!t.tasks.canCancel,onClick:e[0]||(e[0]=(...c)=>o.onButtonCancel&&o.onButtonCancel(...c))},"Cancel Task",8,$s),a("button",{class:"btn requeue",disabled:!t.tasks.canRequeue,onClick:e[1]||(e[1]=(...c)=>o.onButtonRequeue&&o.onButtonRequeue(...c))},"Requeue",8,As)])}var Ls=y(Is,[["render",Ps]]);const Rs={emits:["tableRowClicked"],props:["jobID","taskID"],components:{TaskActionsBar:Ls,StatusFilterBar:st},data:()=>({tasks:U(),shownStatuses:[],availableStatuses:[]}),mounted(){window.tasksTableVue=this;const t=this,e={columns:[{title:"Status",field:"status",sorter:"string",formatter:s=>{const n=s.getData().status;return`${at(n)} ${n}`}},{title:"Name",field:"name",sorter:"string"},{title:"Updated",field:"updated",sorter:"alphanum",sorterParams:{alignEmptyValues:"top"},formatter(s){const n=s.getData().updated;return ot(n)}}],rowFormatter(s){const i=s.getData().id===t.taskID;s.getElement().classList.toggle("active-row",i)},initialSort:[{column:"updated",dir:"desc"}],layout:"fitData",layoutColumnsOnNewData:!0,height:"100%",maxHeight:"100%",data:[],selectable:!1};this.tabulator=new q("#flamenco_task_list",e),this.tabulator.on("rowClick",this.onRowClick),this.tabulator.on("tableBuilt",this._onTableBuilt),window.addEventListener("resize",this.recalcTableHeight)},unmounted(){window.removeEventListener("resize",this.recalcTableHeight)},watch:{jobID(){this.fetchTasks()},taskID(t,e){this._reformatRow(t),this._reformatRow(e)},availableStatuses(){this.$nextTick(this.recalcTableHeight)}},methods:{onReconnected(){this.fetchTasks()},sortData(){const t=this.tabulator;t.setSort(t.getSorters())},_onTableBuilt(){this.tabulator.setFilter(this._filterByStatus),this.fetchTasks()},fetchTasks(){if(!this.jobID){this.tabulator.setData([]);return}new D(g()).fetchJobTasks(this.jobID).then(this.onTasksFetched,function(e){console.error(e)})},onTasksFetched(t){this.tabulator.setData(t.tasks),this._refreshAvailableStatuses(),this.recalcTableHeight()},processTaskUpdate(t){this.tabulator.initialized&&this.tabulator.updateData([t]).then(this.sortData).then(()=>{this.tabulator.redraw()}),this._refreshAvailableStatuses()},onRowClick(t,e){const s=plain(e.getData());this.$emit("tableRowClicked",s)},toggleStatusFilter(t){const e=new Set(this.shownStatuses);e.delete(t)||e.add(t),this.shownStatuses=Array.from(e).sort(),this.tabulator.refreshFilter()},_filterByStatus(t){return this.shownStatuses.length==0?!0:this.shownStatuses.indexOf(t.status)>=0},_refreshAvailableStatuses(){const t=new Set;for(let e of this.tabulator.getData())t.add(e.status);this.availableStatuses=Array.from(t).sort()},_reformatRow(t){const e=this.tabulator.rowManager.findRow(t);!e||(e.reformat?e.reformat():e.reinitialize&&e.reinitialize(!0))},recalcTableHeight(){if(!this.tabulator.initialized)return;const e=this.tabulator.element.parentElement,s=e.parentElement;if(!s)return;const n=s.clientHeight-12;if(e.offsetParent!=e.parentElement){console.warn("TaskTable.recalcTableHeight() only works when the offset parent is the real parent of the element.");return}const i=n-e.offsetTop;this.tabulator.element.clientHeight!=i&&this.tabulator.setHeight(i)}}},Bs=a("h3",{class:"sub-title"},"Tasks",-1),Es={class:"btn-bar-group"},Fs={class:"align-right"},qs=a("div",null,[a("div",{class:"task-list with-clickable-row",id:"flamenco_task_list"})],-1);function Us(t,e,s,n,i,o){const c=p("task-actions-bar"),d=p("status-filter-bar");return l(),r(b,null,[Bs,a("div",Es,[f(c),a("div",Fs,[f(d,{availableStatuses:t.availableStatuses,activeStatuses:t.shownStatuses,onClick:o.toggleStatusFilter},null,8,["availableStatuses","activeStatuses","onClick"])])]),qs],64)}var xs=y(Rs,[["render",Us]]);const Hs={name:"JobsView",props:["jobID","taskID"],components:{FooterPopup:Pt,GetTheAddon:Ut,JobDetails:Ue,JobsTable:as,NotificationBar:gt,TaskDetails:Js,TasksTable:xs,UpdateListener:Dt},data:()=>({messages:[],jobs:V(),tasks:U(),notifs:R(),taskLog:it(),showFooterPopup:!!localStorage.getItem("footer-popover-visible")}),computed:{hasJobData(){return!objectEmpty(this.jobs.activeJob)}},mounted(){window.jobsView=this,window.footerPopup=this.$refs.footerPopup,this._fetchJob(this.jobID),this._fetchTask(this.taskID),window.addEventListener("resize",this._recalcTasksTableHeight)},unmounted(){window.removeEventListener("resize",this._recalcTasksTableHeight)},watch:{jobID(t,e){this._fetchJob(t)},taskID(t,e){this._fetchTask(t)},showFooterPopup(t){t?localStorage.setItem("footer-popover-visible","true"):localStorage.removeItem("footer-popover-visible"),this._recalcTasksTableHeight()}},methods:{onTableJobClicked(t){t.id!=this.jobID&&this._routeToJob(t.id)},onTableTaskClicked(t){this._routeToTask(t.id)},onActiveJobDeleted(t){this._routeToJobOverview()},onSelectedTaskChanged(t){if(!t){this.tasks.deselectAllTasks();return}new D(g()).fetchTask(t.id).then(s=>{this.tasks.setActiveTask(s),this.$refs.tasksTable&&this.$refs.tasksTable.processTaskUpdate(s)})},showTaskLogTail(){this.showFooterPopup=!0,this.$nextTick(()=>{this.$refs.footerPopup.showTaskLogTail()})},onSioJobUpdate(t){this.notifs.addJobUpdate(t),this.jobs.setIsJobless(!1),this.$refs.jobsTable&&this.$refs.jobsTable.processJobUpdate(t),!(this.jobID!=t.id||t.was_deleted)&&(this._fetchJob(this.jobID),t.refresh_tasks&&(this.$refs.tasksTable&&this.$refs.tasksTable.fetchTasks(),this._fetchTask(this.taskID)))},onSioTaskUpdate(t){this.$refs.tasksTable&&this.$refs.tasksTable.processTaskUpdate(t),this.taskID==t.id&&this._fetchTask(this.taskID),this.notifs.addTaskUpdate(t)},onSioTaskLogUpdate(t){this.taskLog.addTaskLogUpdate(t)},onSioLastRenderedUpdate(t){this.$refs.jobDetails.refreshLastRenderedImage(t)},_routeToJobOverview(){const t={name:"jobs"};this.$router.push(t)},_routeToJob(t){const e={name:"jobs",params:{jobID:t}};this.$router.push(e)},_routeToTask(t){const e={name:"jobs",params:{jobID:this.jobID,taskID:t}};this.$router.push(e)},_fetchJob(t){if(!t){this.jobs.deselectAllJobs();return}return new D(g()).fetchJob(t).then(s=>{this.jobs.setActiveJob(s),this.$refs.jobsTable.processJobUpdate(s),this._recalcTasksTableHeight()}).catch(s=>{if(s.status==404){this.jobs.deselectAllJobs();return}console.log(`Unable to fetch job ${t}:`,s)})},_fetchTask(t){if(!t){this.tasks.deselectAllTasks();return}return new D(g()).fetchTask(t).then(s=>{this.tasks.setActiveTask(s),this.$refs.tasksTable&&this.$refs.tasksTable.processTaskUpdate(s)})},onChatMessage(t){console.log("chat message received:",t),this.messages.push(`${t.text}`)},onSIOReconnected(){this.$refs.jobsTable.onReconnected(),this.$refs.tasksTable&&this.$refs.tasksTable.onReconnected()},onSIODisconnected(t){},_recalcTasksTableHeight(){!this.$refs.tasksTable||this.$nextTick(this.$refs.tasksTable.recalcTableHeight)}}},Ns=t=>(P("data-v-afaca560"),t=t(),L(),t),Vs={class:"col col-1"},zs={class:"col col-2 job-details-column",id:"col-job-details"},Ws={class:"col col-3"},Ms=Ns(()=>a("div",{class:"app-footer-expand"},[a("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[a("line",{x1:"12",y1:"19",x2:"12",y2:"5"}),a("polyline",{points:"5 12 12 5 19 12"})])],-1));function Os(t,e,s,n,i,o){const c=p("jobs-table"),d=p("get-the-addon"),h=p("job-details"),k=p("tasks-table"),_=p("task-details"),m=p("notification-bar"),T=p("footer-popup"),W=p("update-listener");return l(),r(b,null,[a("div",Vs,[f(c,{ref:"jobsTable",activeJobID:s.jobID,onTableRowClicked:o.onTableJobClicked,onActiveJobDeleted:o.onActiveJobDeleted},null,8,["activeJobID","onTableRowClicked","onActiveJobDeleted"])]),a("div",zs,[t.jobs.isJobless?(l(),I(d,{key:0})):(l(),r(b,{key:1},[f(h,{ref:"jobDetails",jobData:t.jobs.activeJob,onReshuffled:o._recalcTasksTableHeight},null,8,["jobData","onReshuffled"]),o.hasJobData?(l(),I(k,{key:0,ref:"tasksTable",jobID:s.jobID,taskID:s.taskID,onTableRowClicked:o.onTableTaskClicked},null,8,["jobID","taskID","onTableRowClicked"])):j("",!0)],64))]),a("div",Ws,[o.hasJobData?(l(),I(_,{key:0,taskData:t.tasks.activeTask,onShowTaskLogTail:o.showTaskLogTail},null,8,["taskData","onShowTaskLogTail"])):j("",!0)]),t.showFooterPopup?j("",!0):(l(),r("footer",{key:0,class:"app-footer",onClick:e[0]||(e[0]=ct=>t.showFooterPopup=!0)},[f(m),Ms])),t.showFooterPopup?(l(),I(T,{key:1,ref:"footerPopup",onClickClose:e[1]||(e[1]=ct=>t.showFooterPopup=!1)},null,512)):j("",!0),f(W,{ref:"updateListener",mainSubscription:"allJobs",subscribedJobID:s.jobID,subscribedTaskID:s.taskID,onJobUpdate:o.onSioJobUpdate,onTaskUpdate:o.onSioTaskUpdate,onTaskLogUpdate:o.onSioTaskLogUpdate,onLastRenderedUpdate:o.onSioLastRenderedUpdate,onMessage:o.onChatMessage,onSioReconnected:o.onSIOReconnected,onSioDisconnected:o.onSIODisconnected},null,8,["subscribedJobID","subscribedTaskID","onJobUpdate","onTaskUpdate","onTaskLogUpdate","onLastRenderedUpdate","onMessage","onSioReconnected","onSioDisconnected"])],64)}var Ys=y(Hs,[["render",Os],["__scopeId","data-v-afaca560"]]);export{Ys as default};
